#!/usr/bin/env perl
use strict;
use warnings;
use Text::Trim qw(trim);
use File::Remove qw(rm);
use Getopt::Std;

my %opts;
getopts('gro:', \%opts);
my $out = "output.mkv";
$out = $opts{o} if ($opts{o});
my $pos;

if (not $opts{r}) {
	print "Click on the window you wish to record.\n";
	my @info = split /\n/, `xwininfo`;
	my ($x, $y, $w, $h);
	foreach (@info) {
		my @fields = split /:/;
		@fields = map { trim $_ } @fields;
		if (/Absolute upper-left X/) {
			$x = $fields[1];
		} elsif (/Absolute upper-left Y/) {
			$y = $fields[1];
		} elsif (/Width/) {
			$w = $fields[1];
		} elsif (/Height/) {
			$h = $fields[1];
		}
	}
	$pos = "-s ${w}x${h} -i :0.0+${x},${y}";
} else {
	$pos = "-s 1680x800 -i :0.0+0,0";
}
print "Starting ffmpeg, press ^C to stop recording.\n";
system("ffmpeg -y -ac 2 -f x11grab -r 30 $pos -acodec pcm_s16le -vcodec libx264 -preset ultrafast -crf 0 -threads 0 output.mkv >/dev/null 2>&1");

if ($opts{g}) {
	$out = "output.gif" unless ($opts{o});
	mkdir "frames";
	print "\nConverting to keyframes...\n";
	system("ffmpeg -i output.mkv -r 10 frames/ffout%03d.png > /dev/null 2>&1");
	print "Converting to GIF...\n";
	system("convert -delay 10 -loop 0 frames/ffout*.png $out");
	rm(\1, 'frames');
	rm(\1, "output.mkv");
} else {
	system("mv output.mkv $out");
}
