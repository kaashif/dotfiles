#!/bin/sh

# Delete the stupid branches hg-git sometimes adds
git branch | cut -c3- | grep -E -o '.{40}' | xargs -n1 git branch -d

token_path=/home/git/token

if curl -s -u $(cat $token_path):x-oauth-basic https://api.github.com/users/kaashif/repos | jq -M -r ".[].name" | grep -E "^${GL_REPO}\$"; then
        echo "Repo $GL_REPO found on GitHub. Pushing..."
        git push -f --mirror git@github.com:kaashif/${GL_REPO}.git
else
        echo "Repo $GL_REPO not found on GitHub. Creating..."
        curl -H "Content-Type: application/json" -X POST -s -u $(cat $token_path):x-oauth-basic -d "{ \"name\": \"${GL_REPO}\" }" https://api.github.com/user/repos
        echo "Pushing..."
        git push -f --mirror git@github.com:kaashif/${GL_REPO}.git
fi
exit 0
